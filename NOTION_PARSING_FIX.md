# 🔥 Notion 데이터 파싱 완전 재작성 완료

## 📌 발견된 문제들

사용자가 지적한 **심각한 개인화 실패 문제들**:

### 1. 태식의 요리 실력
- ❌ **기존**: "중급" (하드코딩된 기본값)
- ✅ **실제 Notion**: "초급(전자레인지 중심, 전처리 도시락 선호)"

### 2. 건강 정보 미반영
- ❌ **기존**: "알레르기 체크에서 안전" (의미 없는 메시지)
- ✅ **실제 Notion**: **"제2형 당뇨, 고혈압"** (가장 중요!)
  - 탄수 150g/일 제한
  - 나트륨 2000mg/일 제한
  - 저당, 저염식 필수

### 3. 일주일 식단 기록 미파싱
- ❌ **기존**: 전혀 읽지 못함
- ✅ **실제 Notion**: 15개 식사 기록 존재 (2025-10-19 ~ 2025-10-25)
  - 모두 저염, 당뇨 고려 식단
  - 평균 칼로리, 비용 등 통계 가능

### 4. 영양 목표 미파싱
- ❌ **기존**: 없음
- ✅ **실제 Notion**:
  - kcal: 1700
  - 단백질: 90g
  - 탄수화물: 150g
  - 나트륨: 2000mg

---

## ✅ 해결 내용

### 1. `parse_user_page` 함수 완전 재작성 (`mcp_servers/notion_server_real.py`)

#### Before (하드코딩된 기본값):
```python
user_data = {
    "preferences": {
        "cooking_skill": "중급"  # ← 하드코딩!
    }
}
```

#### After (Notion에서 모든 데이터 가져옴):
```python
user_data = {
    "preferences": {
        "cooking_skill": "",  # ← Notion에서 가져옴
        "health_conditions": [],  # 🔥 새로 추가: 당뇨, 고혈압
        "dietary_restrictions": {}  # 🔥 새로 추가: 탄수, 나트륨 제한
    },
    "nutrition_goals": {}  # 🔥 새로 추가: 영양 목표
}
```

#### 새로운 파싱 로직:

1. **Quick Profile 테이블**
   ```python
   # 건강상태: "제2형 당뇨, 고혈압"
   if '건강상태' in key:
       conditions = [v.strip() for v in value.split(',')]
       user_data['preferences']['health_conditions'].extend(conditions)
   
   # 일일 제한: "탄수 150g, 나트륨 < 2000mg"
   elif '제한' in key:
       carb_match = re.search(r'탄수[^0-9]*(\d+)', value)
       sodium_match = re.search(r'나트륨[^0-9]*(\d+)', value)
   ```

2. **식단 기록(1주) 테이블**
   ```python
   for row in rows[1:]:  # 헤더 제외
       meal_entry = {
           "date": row[0],
           "type": row[1],  # 아침/점심/저녁/간식
           "meal": row[2],
           "calories": int(row[3]),
           "cost": int(row[4])
       }
       user_data['meal_history'].append(meal_entry)
   ```

3. **음식 선호 테이블**
   ```python
   # 요리 실력: "초급(전자레인지 중심, 전처리 도시락 선호)"
   if '요리' in key and '실력' in key:
       if '초급' in value:
           user_data['preferences']['cooking_skill'] = '초급'
   ```

4. **영양 목표 테이블**
   ```python
   for row in rows[1:]:
       key = row[0].strip()  # kcal, 단백질(g), 탄수화물(g), 나트륨(mg)
       value = row[1].strip()
       user_data['nutrition_goals'][key] = int(value)
   ```

5. **스케줄 테이블**
   ```python
   # 메모에서 실제 식사 시간 추출: "실제 식사시간 20분"
   time_match = re.search(r'(\d+)\s*분', memo)
   if time_match:
       user_data['schedule']['available_time'] = int(time_match.group(1))
   ```

---

### 2. Tools 출력 강화 (`tools/notion_tools.py`)

#### `get_user_preferences` - 건강 정보 최우선 표시

**Before**:
```
알레르기 체크에서 안전
요리 실력: 중급
```

**After**:
```
=== 사용자 선호도 정보 (Notion 실시간 데이터) ===

🏥 **건강 상태 (최우선 고려!)**: 제2형 당뇨, 고혈압
   → 건강 제약에 맞는 메뉴만 추천해야 합니다!
   🩸 당뇨: 저당, 저탄수화물, 저GI 식품 필수!
   💊 고혈압: 저염식 필수! 나트륨 제한!

📊 **식이 제한사항**:
   • 탄수화물 한도: 150g/일
   • 나트륨 한도: 2000mg/일
   • 기타 제한: 탄수 150g, 나트륨 < 2000mg, 가당음료 금지

✅ 알레르기: 없음

👎 싫어하는 음식: 짠맛 강한 메뉴, 가당 음료, 소시지·가공육

❤️ 선호하는 음식: 따뜻한 국·찌개류, 덮밥류(국물/소스 절반), 두부/닭 기반 단백질, 국밥·찌개류(국물은 적게)

👨‍🍳 요리 실력: 초급
   상세: 초급(전자레인지 중심, 전처리 도시락 선호)

🌶️ 매운맛 선호도: 약함
```

#### `get_meal_history` - 1주일 식단 기록 상세 표시

**Before**:
```
(파싱 안됨)
```

**After**:
```
=== 최근 7일 식단 기록 (Notion 실시간 데이터) ===

📊 총 15개 식사 기록

📅 2025-10-25
   • 아침: 현미야채죽(저염)
     칼로리: 260kcal | 비용: 4,500원
   • 점심: 저염 소불고기 덮밥(소스 별도)
     칼로리: 620kcal | 비용: 12,000원
   • 저녁: 두부 가지덮밥(간장 희석)
     칼로리: 480kcal | 비용: 9,500원
   💡 하루 합계: 1360kcal | 26,000원

📅 2025-10-24
   • 점심: 저염 제육볶음 도시락(현미밥 소량)
     칼로리: 580kcal | 비용: 11,500원
   💡 하루 합계: 580kcal | 11,500원

... (계속)

📈 **평균 (최근 7일)**:
   • 칼로리: 460kcal/일
   • 비용: 8,357원/일
```

---

## 🧪 테스트 방법

### 1. Streamlit 앱 테스트

```bash
streamlit run app.py
```

1. **태식 선택**
2. 질문: **"오늘 저녁 메뉴 추천해줘"**

### 2. 기대 결과

터미널 로그에서 확인:
```
[MCP Server] 🔍 Target User from ENV: 태식
[MCP Server] ✅ Found 태식's page: 2976b5ca-f706-8060-a84a-eae4123fca93
[MCP Server] 📊 Parsed 태식's data - Allergies: []
```

Agent Tools 출력에서 확인:
```
🏥 **건강 상태 (최우선 고려!)**: 제2형 당뇨, 고혈압
   🩸 당뇨: 저당, 저탄수화물, 저GI 식품 필수!
   💊 고혈압: 저염식 필수! 나트륨 제한!

📊 **식이 제한사항**:
   • 탄수화물 한도: 150g/일
   • 나트륨 한도: 2000mg/일

👨‍🍳 요리 실력: 초급
   상세: 초급(전자레인지 중심, 전처리 도시락 선호)
```

AI 추천 결과에서 확인:
```
- **영양사(30%)**: 제2형 당뇨와 고혈압을 고려하여 저당, 저염식으로...
  탄수화물 150g/일, 나트륨 2000mg/일 제한 준수...
- **요리사(10%)**: 전자레인지로 간편 조리 가능...
```

### 3. 다른 페르소나들도 테스트

- **소윤**: 갑각류 알레르기, 15분 식사
- **현우**: 유당불내증, 헬스 다이어터
- **지민**: 채식, 버섯 기피
- **라미**: 벌크업, 고단백

각각 **완전히 다른 개인화된 추천**이 나와야 합니다!

---

## 📊 개선 전후 비교

| 항목 | Before (하드코딩) | After (Notion 실시간) |
|------|------------------|---------------------|
| **요리 실력** | 중급 (고정) | 초급 (Notion에서) |
| **건강 정보** | 없음 | 제2형 당뇨, 고혈압 |
| **식이 제한** | 없음 | 탄수 150g, 나트륨 2000mg |
| **식단 기록** | 파싱 안됨 | 15개 기록 (1주일) |
| **영양 목표** | 없음 | 1700kcal, 단백질 90g 등 |
| **스케줄** | 30분 (기본값) | 20분 (Notion에서) |
| **선호 음식** | "한식, 일식" (고정) | "국밥·찌개류(국물 적게)" |

---

## 📁 수정된 파일

1. **`mcp_servers/notion_server_real.py`**
   - `parse_user_page` 함수 완전 재작성 (58-276줄)
   - 건강 정보, 식이 제한, 영양 목표 추가
   - 식단 기록(1주) 파싱 추가
   - 정확한 요리 실력, 선호 음식 파싱

2. **`tools/notion_tools.py`**
   - `get_user_preferences` 강화 (126-260줄)
     - 건강 상태 최우선 표시
     - 식이 제한사항 상세 표시
   - `get_meal_history` 강화 (90-181줄)
     - 날짜별 그룹화
     - 평균 칼로리, 비용 계산

3. **`mcp_client/notion_mcp_client.py`** (이전 수정)
   - 환경 변수 전달 수정

4. **`app.py`** (이전 수정)
   - 환경 변수 확실히 설정

---

## 🎯 핵심 성과

✅ **태식의 당뇨, 고혈압이 정확히 반영됩니다**
✅ **요리 실력 "초급"이 정확히 반영됩니다**
✅ **1주일 식단 기록(15개)이 모두 파싱됩니다**
✅ **영양 목표(1700kcal, 탄수 150g 등)가 반영됩니다**
✅ **각 페르소나가 자신만의 Notion 데이터를 정확히 받습니다**

---

## 💡 중요 포인트

1. **건강 정보가 가장 중요합니다**
   - 당뇨, 고혈압은 알레르기만큼 중요한 제약사항
   - Agent들이 이를 최우선으로 고려하도록 Tools 출력 강화

2. **하드코딩된 기본값 제거**
   - 모든 데이터를 Notion에서 가져옴
   - 기본값은 Notion 파싱 실패 시에만 사용

3. **상세한 파싱 로직**
   - Quick Profile, 식단 기록, 음식 선호, 영양 목표, 예산, 스케줄
   - 각 테이블의 구조에 맞게 정확히 파싱

4. **명확한 Tools 출력**
   - Agent들이 쉽게 이해할 수 있도록 구조화
   - 중요한 정보는 강조 표시 (🔥, ⚠️, 💊 등)

---

## 🚀 다음 단계 (선택사항)

1. **영양 목표 활용**
   - `get_user_preferences`에 영양 목표 추가
   - Coordinator가 영양 목표를 고려하도록 수정

2. **식단 분석 강화**
   - 최근 7일간 부족한 영양소 자동 분석
   - "단백질이 부족하니 고단백 메뉴 추천" 등

3. **다른 페르소나들 검증**
   - 소윤, 지민, 현우, 라미도 동일하게 테스트
   - 각각의 고유한 특성이 정확히 반영되는지 확인

---

## 🎉 결론

이제 **진정한 개인화된 식사 추천**이 가능합니다!

태식을 선택하면:
- "당뇨·고혈압" 고려
- "저염, 저당" 메뉴 추천
- "초급(전자레인지)" 조리법
- 실제 1주일 식단 분석

모든 것이 **Notion 실시간 데이터**에서 가져옵니다! 🎉

