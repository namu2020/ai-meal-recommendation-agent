# 영양사 에이전트 무한 루프 문제 해결

## 문제점 분석

### 1. 주요 문제
- **영양사 에이전트의 무한 툴 호출 루프** 발생
- task description이 너무 복잡 (122줄)하여 에이전트가 혼란
- LLM Judge 도구가 프롬프트만 반환하고 실제 판단을 하지 않음
- 도구 호출 제한이 명확하지 않아 반복 호출 발생

### 2. 근본 원인
- **복잡한 지시사항**: 영양사 에이전트에게 너무 많은 단계와 조건 제시
- **불명확한 종료 조건**: "결과가 없으면 종료"라는 지시가 여러 번 있지만 에이전트가 무시
- **도구 중복**: `judge_menu_personalization`, `get_restaurant_details` 등 불필요한 도구 제공
- **max_iter 과다**: 15회로 설정되어 있어 너무 많은 시도 허용

## 해결 방안

### 1. 영양사 에이전트 간소화 (`agents/nutrition_agent.py`)

#### Before (복잡한 구조)
```python
goal=(
    "사용자의 Notion 데이터를 활용하여 개인화된 건강 식단을 추천합니다. "
    "반드시 다음 순서로 작업하세요:\n"
    "1. **알레르기 정보 필수 확인**...\n"
    "2. **식단 기록 분석**...\n"
    # ... 매우 긴 설명
),
```

#### After (간결한 구조)
```python
goal=(
    "사용자의 건강과 영양을 최우선으로 고려하여 안전하고 균형잡힌 식단을 추천합니다. "
    "⚠️ 반드시 다음 3단계만 수행하세요:\n\n"
    "1️⃣ **사용자 정보 확인** (도구 2개만 사용)\n"
    "   - '사용자 선호도 조회' 도구로 알레르기, 식이 제한 확인\n"
    "   - '식단 기록 조회' 도구로 최근 식단 확인\n\n"
    "2️⃣ **레스토랑 검색** (도구 1회만 사용)\n"
    "   - '레스토랑 검색 (예산 및 시간 기반)' 도구로 후보 찾기\n"
    "   - 결과가 없어도 재시도하지 말고 다음 단계로\n\n"
    "3️⃣ **최종 추천 작성** (도구 사용 없음)\n"
    "   - 알레르기 안전성 확인\n"
    "   - 영양학적으로 적합한 메뉴 3-5개 선정\n"
    "   - 작업 완료 및 종료"
),
```

### 2. 도구 목록 축소

#### Before (5개 도구)
```python
tools=[
    get_user_preferences,
    get_meal_history,
    search_restaurants,
    get_restaurant_details,        # 제거
    judge_menu_personalization     # 제거 (혼란 야기)
],
```

#### After (3개 도구만)
```python
tools=[
    get_user_preferences,
    get_meal_history,
    search_restaurants
],
```

### 3. Task Description 간소화 (`crew.py`)

#### Before (53줄의 복잡한 지시사항)
- 16단계의 상세한 지시
- 도구 호출 횟수가 불명확 ("최대 2-3회", "최대 5회")
- LLM Judge 도구 사용 요구

#### After (간결한 3단계)
```python
description=(
    "당신은 영양사입니다. 정확히 다음 3단계만 수행하세요:\n\n"
    
    "**1단계: 사용자 정보 확인 (2개 도구)**\n"
    "- '사용자 선호도 조회' 도구로 알레르기, 식이 제한(채식 등), 건강 상태 확인\n"
    "- '식단 기록 조회' 도구로 최근 식단 확인\n\n"
    
    "**2단계: 레스토랑 검색 (1회만!)**\n"
    "- '레스토랑 검색 (예산 및 시간 기반)' 도구를 1회만 사용\n"
    "- 결과가 없으면 '조건에 맞는 메뉴가 없습니다'라고 보고하고 종료\n"
    "- ⚠️ 절대 재시도하지 마세요!\n\n"
    
    "**3단계: 최종 추천 작성 (도구 사용 없음)**\n"
    "- 알레르기 안전성 확인하여 메뉴 선정\n"
    "- 작업 완료\n\n"
    
    "⚠️ **중요 규칙**\n"
    "- 도구는 총 3개만 사용: 선호도 조회(1) + 식단 기록(1) + 레스토랑 검색(1)\n"
    "- 같은 도구를 반복 호출하지 마세요\n"
    "- 결과가 부족해도 가용한 정보로 작업을 완료하고 종료하세요"
),
```

### 4. max_iter 최적화

#### Before
```python
self.nutrition_agent.max_iter = 15  # 너무 많음
```

#### After
```python
self.nutrition_agent.max_iter = 8  # 도구 3개 + 분석 = 최대 8회면 충분
```

## 핵심 개선 사항

### 1. 명확한 단계별 지시
- **3단계 구조**: 정보 확인 → 검색 → 추천 작성
- 각 단계에서 사용할 도구와 횟수를 명확히 지정
- "도구 사용 없음"을 명시하여 불필요한 호출 방지

### 2. 도구 호출 제한 강화
- **총 3개 도구만 허용**: 더 이상 사용할 도구가 없음을 명확히
- **재시도 금지**: "절대 재시도하지 마세요" 명시
- **종료 조건 명확화**: "작업 완료 및 종료" 명시

### 3. 불필요한 도구 제거
- `judge_menu_personalization`: LLM이 프롬프트만 반환하여 혼란 야기 → 제거
- `get_restaurant_details`: 추가 검색으로 루프 유발 → 제거
- 에이전트가 검색 결과를 직접 분석하도록 단순화

### 4. 작업 효율성 향상
- backstory에서 "작업 효율성" 섹션 추가
- "결과가 부족해도 가용 정보로 작업 완료" 강조
- "절대 같은 도구를 반복 호출하지 마세요" 명시

## 테스트 시나리오

### 지민 페르소나 (평일 락토오보 채식주의자)
```json
{
  "preferences": {
    "dietary_restrictions": {
      "평일": "락토오보 (고기와 생선은 불가)",
      "주말": "페스코 (생선과 해물은 가능)"
    },
    "dislikes": ["버섯"],
    "favorite_cuisines": ["한식", "샐러드", "두부 요리"]
  },
  "schedule": {
    "today": "2025-10-27 (월요일)",
    "available_time": 45
  },
  "budget": {
    "daily_limit": 18000,
    "today_spent": 9000
  }
}
```

### 예상 동작
1. **1단계**: 사용자 선호도 조회 (락토오보 확인) + 식단 기록 조회
2. **2단계**: 레스토랑 검색 (예산 9000원, 시간 45분) - 1회만
3. **3단계**: 
   - 고기 메뉴 제외 (락토오보)
   - 버섯 메뉴 제외 (싫어함)
   - 채소, 두부, 계란 요리 위주로 3-5개 선정
   - 작업 완료

### 예상 결과
- 도구 호출: 정확히 3회
- 반복 횟수: 6-8회 이내
- 무한 루프: 발생하지 않음
- 추천 메뉴: 채식 위주 3-5개

## 추가 개선 사항

### 다른 에이전트들도 동일한 패턴 적용
- **예산 관리자**: 3단계 구조 (예산 조회 → 검색 → 추천)
- **일정 관리자**: 3단계 구조 (일정 조회 → 검색 → 추천)
- **맛슐랭**: 간결한 지시사항

### 전체 시스템 효율성
- 각 에이전트의 max_iter를 8-10으로 제한
- 명확한 종료 조건 제시
- 도구 중복 제거

## 결론

이번 수정으로:
1. ✅ **무한 루프 방지**: 도구 호출 횟수와 단계를 명확히 제한
2. ✅ **작업 효율성 향상**: 불필요한 도구와 복잡한 로직 제거
3. ✅ **명확한 지시**: 3단계 구조로 에이전트가 따르기 쉬움
4. ✅ **빠른 실행**: max_iter 감소로 응답 시간 단축

영양사 에이전트가 이제 **간단하고 효율적**으로 작동하며, 무한 루프에 빠지지 않고 정확히 필요한 만큼만 도구를 호출합니다.

