"""
CrewAI ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ - ë™ì  ì›Œí¬í”Œë¡œìš° ê´€ë¦¬
"""
from crewai import Crew, Task
from crewai.process import Process
from agents import (
    create_chef_agent,
    create_taste_agent,
    create_nutrition_agent,
    create_budget_agent,
    create_scheduler_agent,
    create_coordinator_agent,
)
from agents.orchestrator_agent import create_orchestrator_agent
from config import get_llm, CREW_CONFIG
import json


class FoodRecommendationCrew:
    """ìŒì‹ ì¶”ì²œ í¬ë£¨ í´ë˜ìŠ¤ - ë™ì  ì›Œí¬í”Œë¡œìš° ì§€ì›"""
    
    def __init__(self):
        """í¬ë£¨ ì´ˆê¸°í™”"""
        self.llm = get_llm()
        
        # ëª¨ë“  ì—ì´ì „íŠ¸ ìƒì„± (ë¬´í•œ ì¬ê·€ ë°©ì§€ ì„¤ì • í¬í•¨)
        self.orchestrator_agent = create_orchestrator_agent(self.llm)
        self.chef_agent = create_chef_agent(self.llm)
        self.taste_agent = create_taste_agent(self.llm)
        self.nutrition_agent = create_nutrition_agent(self.llm)
        self.budget_agent = create_budget_agent(self.llm)
        self.scheduler_agent = create_scheduler_agent(self.llm)
        self.coordinator_agent = create_coordinator_agent(self.llm)
        
        # ì—ì´ì „íŠ¸ë³„ ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜ ì„¤ì • (ë¬´í•œ ì¬ê·€ ë°©ì§€)
        self.nutrition_agent.max_iter = 5  # ë„êµ¬ 2ê°œë§Œ ì‚¬ìš© = 5íšŒë©´ ì¶©ë¶„
        self.budget_agent.max_iter = 8
        self.scheduler_agent.max_iter = 8
        self.chef_agent.max_iter = 8
        self.taste_agent.max_iter = 10  # ë§›ìŠë­ì€ ê²€ìƒ‰ì´ í•„ìš”í•´ì„œ ì¡°ê¸ˆ ë”
        self.coordinator_agent.max_iter = 8
        
        # ì—ì´ì „íŠ¸ ë§¤í•‘
        self.agent_map = {
            "chef_agent": self.chef_agent,
            "taste_agent": self.taste_agent,
            "nutrition_agent": self.nutrition_agent,
            "budget_agent": self.budget_agent,
            "scheduler_agent": self.scheduler_agent,
        }
        
        # ëŒ€í™” íˆìŠ¤í† ë¦¬
        self.conversation_history = []
        
        # ë ˆì‹œí”¼ ìºì‹œ (ë©”ë‰´ëª… -> ë ˆì‹œí”¼ ë§¤í•‘)
        self.recipe_cache = {}
    
    def analyze_intent(self, user_request: str) -> dict:
        """
        ì‚¬ìš©ì ì˜ë„ ë¶„ì„
        Returns: {workflow_type, required_agents, primary_agent, reasoning, user_intent}
        """
        # ëŒ€í™” ë§¥ë½ ì¤€ë¹„
        history_str = "\n".join(self.conversation_history[-3:]) if self.conversation_history else ""
        
        # ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ë¡œ ì˜ë„ ë¶„ì„
        intent_task = Task(
            description=(
                f"ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ë¶„ì„í•˜ì—¬ í•„ìš”í•œ ì›Œí¬í”Œë¡œìš°ë¥¼ ê²°ì •í•˜ì„¸ìš”.\n\n"
                f"ì‚¬ìš©ì ë©”ì‹œì§€: {user_request}\n"
                f"ëŒ€í™” ë§¥ë½: {history_str if history_str else 'ì—†ìŒ (ì²« ëŒ€í™”)'}\n\n"
                f"'ì‚¬ìš©ì ì˜ë„ ë¶„ì„' ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¶„ì„í•˜ê³  JSON ê²°ê³¼ë¥¼ ê·¸ëŒ€ë¡œ ë°˜í™˜í•˜ì„¸ìš”."
            ),
            expected_output="JSON í˜•ì‹ì˜ ì˜ë„ ë¶„ì„ ê²°ê³¼",
            agent=self.orchestrator_agent
        )
        
        # ë¶„ì„ ì‹¤í–‰
        crew = Crew(
            agents=[self.orchestrator_agent],
            tasks=[intent_task],
            process=Process.sequential,
            verbose=False
        )
        
        result = crew.kickoff()
        
        # JSON íŒŒì‹±
        try:
            # ê²°ê³¼ì—ì„œ JSON ì¶”ì¶œ
            result_str = str(result)
            if "```json" in result_str:
                result_str = result_str.split("```json")[1].split("```")[0].strip()
            elif "```" in result_str:
                result_str = result_str.split("```")[1].split("```")[0].strip()
            
            # JSON ë¶€ë¶„ë§Œ ì¶”ì¶œ (ì¤‘ê´„í˜¸ë¡œ ì‹œì‘í•˜ê³  ëë‚˜ëŠ” ë¶€ë¶„)
            start_idx = result_str.find('{')
            end_idx = result_str.rfind('}')
            if start_idx != -1 and end_idx != -1:
                result_str = result_str[start_idx:end_idx+1]
            
            intent = json.loads(result_str)
            print(f"\nğŸ¯ ì˜ë„ ë¶„ì„ ê²°ê³¼: {intent.get('workflow_type')} - {intent.get('user_intent')}")
            print(f"   í•„ìš” ì—ì´ì „íŠ¸: {', '.join(intent.get('required_agents', []))}\n")
            return intent
        except Exception as e:
            print(f"âš ï¸ ì˜ë„ ë¶„ì„ íŒŒì‹± ì‹¤íŒ¨: {e}")
            print(f"Raw result: {result}")
            # ê¸°ë³¸ê°’ ë°˜í™˜
            return {
                "workflow_type": "FULL_RECOMMENDATION",
                "required_agents": ["taste_agent", "nutrition_agent", "budget_agent", "scheduler_agent", "chef_agent"],
                "primary_agent": "taste_agent",
                "reasoning": "íŒŒì‹± ì‹¤íŒ¨ë¡œ ê¸°ë³¸ ì›Œí¬í”Œë¡œìš° ì‚¬ìš©",
                "user_intent": "ë©”ë‰´ ì¶”ì²œ"
            }
    
    def create_dynamic_tasks(self, user_request: str, intent: dict) -> list[Task]:
        """
        ì˜ë„ ë¶„ì„ ê²°ê³¼ì— ë”°ë¼ ë™ì ìœ¼ë¡œ íƒœìŠ¤í¬ ìƒì„±
        """
        workflow_type = intent.get("workflow_type", "FULL_RECOMMENDATION")
        required_agents = intent.get("required_agents", [])
        
        tasks = []
        agent_tasks = {}
        
        print(f"ğŸ“‹ ì›Œí¬í”Œë¡œìš° íƒ€ì…: {workflow_type}")
        print(f"ğŸ‘¥ í™œì„±í™”ëœ ì—ì´ì „íŠ¸: {', '.join(required_agents)}\n")
        
        # RECIPE_ONLY: ë ˆì‹œí”¼ë§Œ í•„ìš”
        if workflow_type == "RECIPE_ONLY":
            # ëŒ€í™” ë§¥ë½ ì¤€ë¹„
            history_context = ""
            if self.conversation_history:
                recent_history = self.conversation_history[-4:]  # ìµœê·¼ 4ê°œ
                history_context = "\n\nğŸ“œ **ëŒ€í™” ë§¥ë½ (ì´ì „ ëŒ€í™” ì°¸ê³ ):**\n" + "\n".join(recent_history)
            
            recipe_task = Task(
                description=(
                    f"ì‚¬ìš©ì ìš”ì²­: {user_request}"
                    f"{history_context}\n\n"
                    
                    "ğŸ¯ **ë‹¹ì‹ ì˜ ì„ë¬´:**\n"
                    "1. ì‚¬ìš©ìê°€ ìš”ì²­í•œ ìš”ë¦¬ë¥¼ ì •í™•íˆ íŒŒì•…í•˜ì„¸ìš” (ì´ì „ ëŒ€í™” ë§¥ë½ ê³ ë ¤!)\n"
                    "2. 'AI ë ˆì‹œí”¼ ìƒì„±' ë„êµ¬ë¥¼ **ë°˜ë“œì‹œ ì‹¤í–‰**í•˜ì„¸ìš”\n"
                    "3. ë„êµ¬ê°€ ë°˜í™˜í•œ ë ˆì‹œí”¼ë¥¼ ì‚¬ìš©ìì—ê²Œ ì¹œì ˆí•˜ê²Œ ì„¤ëª…í•˜ì„¸ìš”\n\n"
                    
                    "âš ï¸ **ì¤‘ìš”: ë„êµ¬ë¥¼ ì‹¤ì œë¡œ ì‹¤í–‰í•˜ì„¸ìš”!**\n"
                    "- âŒ ì˜ëª»ëœ ì˜ˆ: 'AI ë ˆì‹œí”¼ ìƒì„±(dish_name=\"ëœì¥ì°Œê°œ\")' ë¼ê³ ë§Œ ì“°ê¸°\n"
                    "- âœ… ì˜¬ë°”ë¥¸ ì˜ˆ: ë„êµ¬ë¥¼ ì‹¤í–‰í•˜ê³  ê·¸ ê²°ê³¼ë¥¼ ì‚¬ìš©ìì—ê²Œ ì „ë‹¬\n\n"
                    
                    "ğŸ“ **ë„êµ¬ ì‚¬ìš©ë²•:**\n"
                    "- ë„êµ¬ëª…: 'AI ë ˆì‹œí”¼ ìƒì„±'\n"
                    "- íŒŒë¼ë¯¸í„°: dish_name='ìš”ë¦¬ì´ë¦„'\n"
                    "- ì˜ˆì‹œ: AI ë ˆì‹œí”¼ ìƒì„±(dish_name='ëœì¥ì°Œê°œ')\n\n"
                    
                    "ğŸ’¡ **íŒ:**\n"
                    "- ì‚¬ìš©ìê°€ '~ë§ê³ ', 'ë‹¤ë¥¸ ê±°'ë¼ê³  í•˜ë©´ ì´ì „ ëŒ€í™”ë¥¼ ì°¸ê³ í•˜ì„¸ìš”\n"
                    "- ë„êµ¬ë¥¼ í˜¸ì¶œí•˜ê³  ë°˜í™˜ëœ ë ˆì‹œí”¼ ì „ì²´ë¥¼ ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì£¼ì„¸ìš”\n"
                    "- ë ˆì‹œí”¼ ì•ì— ì§§ì€ ì¸ì‚¬ë§ì„ ì¶”ê°€í•˜ë©´ ë” ì¢‹ìŠµë‹ˆë‹¤"
                ),
                expected_output=(
                    "'AI ë ˆì‹œí”¼ ìƒì„±' ë„êµ¬ë¥¼ ì‹¤í–‰í•œ ê²°ê³¼ë¡œ ë°›ì€ ìƒì„¸ ë ˆì‹œí”¼ ì „ì²´. "
                    "ë°˜ë“œì‹œ ì¬ë£Œ, ì¡°ë¦¬ ìˆœì„œ, íŒ, ì˜ì–‘ ì •ë³´ê°€ í¬í•¨ë˜ì–´ì•¼ í•¨."
                ),
                agent=self.chef_agent
            )
            return [recipe_task]
        
        # BUDGET_CHECK: ì˜ˆì‚° í™•ì¸ë§Œ
        elif workflow_type == "BUDGET_CHECK":
            budget_task = Task(
                description=(
                    f"ì‚¬ìš©ì ìš”ì²­: {user_request}\n\n"
                    "ì‚¬ìš©ìì˜ ì˜ˆì‚° í˜„í™©ì„ í™•ì¸í•˜ê³  ë³´ê³ í•˜ì„¸ìš”.\n"
                    "1. 'ì˜ˆì‚° í˜„í™© ì¡°íšŒ' ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.\n"
                    "2. í˜„ì¬ ë‚¨ì€ ì˜ˆì‚°, ì‚¬ìš©í•œ ê¸ˆì•¡, ì„ í˜¸ ê°€ê²©ëŒ€ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.\n"
                    "3. ì˜ˆì‚° ê´€ë¦¬ ì¡°ì–¸ì„ ì œê³µí•˜ì„¸ìš”."
                ),
                expected_output="ì˜ˆì‚° í˜„í™© ë³´ê³ ì„œ",
                agent=self.budget_agent
            )
            return [budget_task]
        
        # NUTRITION_INFO: ì˜ì–‘ ì •ë³´ë§Œ
        elif workflow_type == "NUTRITION_INFO":
            nutrition_task = Task(
                description=(
                    f"ì‚¬ìš©ì ìš”ì²­: {user_request}\n\n"
                    "ì˜ì–‘ ì •ë³´ë¥¼ ì œê³µí•˜ì„¸ìš”.\n"
                    "1. 'ì‹ë‹¨ ê¸°ë¡ ì¡°íšŒ' ë„êµ¬ë¡œ ìµœê·¼ ì‹ë‹¨ì„ í™•ì¸í•˜ì„¸ìš”.\n"
                    "2. ì¹¼ë¡œë¦¬ì™€ ì˜ì–‘ì†Œ ë¶„ì„ì„ ì œê³µí•˜ì„¸ìš”.\n"
                    "3. ê±´ê°• ì¡°ì–¸ì„ ì œê³µí•˜ì„¸ìš”."
                ),
                expected_output="ì˜ì–‘ ì •ë³´ ë° ë¶„ì„",
                agent=self.nutrition_agent
            )
            return [nutrition_task]
        
        # SCHEDULE_CHECK: ì¼ì • í™•ì¸ë§Œ
        elif workflow_type == "SCHEDULE_CHECK":
            schedule_task = Task(
                description=(
                    f"ì‚¬ìš©ì ìš”ì²­: {user_request}\n\n"
                    "ì‚¬ìš©ìì˜ ì¼ì •ì„ í™•ì¸í•˜ê³  ë³´ê³ í•˜ì„¸ìš”.\n"
                    "1. 'ì‚¬ìš©ì ì¼ì • ì¡°íšŒ' ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.\n"
                    "2. ì˜¤ëŠ˜ ì¼ì •ê³¼ ì‹ì‚¬ ê°€ëŠ¥í•œ ì‹œê°„ì„ ì•Œë ¤ì£¼ì„¸ìš”."
                ),
                expected_output="ì¼ì • ë³´ê³ ì„œ",
                agent=self.scheduler_agent
            )
            return [schedule_task]
        
        # QUICK_MEAL: ë¹ ë¥¸ ì‹ì‚¬
        elif workflow_type == "QUICK_MEAL":
            schedule_task = Task(
                description=(
                    f"ì‚¬ìš©ì ìš”ì²­: {user_request}\n\n"
                    "ì‚¬ìš©ìì˜ ê°€ìš© ì‹œê°„ì„ í™•ì¸í•˜ì„¸ìš”.\n"
                    "1. 'ì‚¬ìš©ì ì¼ì • ì¡°íšŒ' ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.\n"
                    "2. ì‹ì‚¬ ê°€ëŠ¥í•œ ì‹œê°„ì„ íŒŒì•…í•˜ì„¸ìš”."
                ),
                expected_output="ê°€ìš© ì‹œê°„ ì •ë³´",
                agent=self.scheduler_agent
            )
            
            quick_taste_task = Task(
                description=(
                    f"ì‚¬ìš©ì ìš”ì²­: {user_request}\n\n"
                    "ë¹ ë¥´ê²Œ ë¨¹ì„ ìˆ˜ ìˆëŠ” ë©”ë‰´ë¥¼ ì¶”ì²œí•˜ì„¸ìš”.\n"
                    "1. 'ë©”ë‰´ ê²€ìƒ‰' ë„êµ¬ë¡œ ì¡°ë¦¬/ë°°ë‹¬ ì‹œê°„ì´ ì§§ì€ ë©”ë‰´ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”.\n"
                    "2. 30ë¶„ ì´ë‚´ì— ê°€ëŠ¥í•œ ë©”ë‰´ 3-5ê°œë¥¼ ì¶”ì²œí•˜ì„¸ìš”.\n"
                    "3. ê° ë©”ë‰´ì˜ ì†Œìš” ì‹œê°„ì„ ëª…í™•íˆ í‘œì‹œí•˜ì„¸ìš”."
                ),
                expected_output="ë¹ ë¥¸ ë©”ë‰´ 3-5ê°œ ì¶”ì²œ",
                agent=self.taste_agent,
                context=[schedule_task]
            )
            
            return [schedule_task, quick_taste_task]
        
        # RESTAURANT_DELIVERY: ì™¸ì‹/ë°°ë‹¬ ì¶”ì²œ
        elif workflow_type == "RESTAURANT_DELIVERY":
            return self.create_restaurant_delivery_tasks(user_request)
        
        # FULL_RECOMMENDATION: ì „ì²´ ë©”ë‰´ ì¶”ì²œ (ê¸°ì¡´ ë¡œì§)
        else:
            return self.create_full_recommendation_tasks(user_request)
    
    def create_full_recommendation_tasks(self, user_request: str) -> list[Task]:
        """ì „ì²´ ë©”ë‰´ ì¶”ì²œì„ ìœ„í•œ ëª¨ë“  íƒœìŠ¤í¬ ìƒì„±"""
        
        # Task 1: ì˜ì–‘ì‚¬ - ê±´ê°• ë° ì˜ì–‘ ë¶„ì„ (Notion ë°ì´í„° ê¸°ë°˜)
        nutrition_task = Task(
            description=(
                f"ì‚¬ìš©ì ìš”ì²­: {user_request}\n\n"
                "ğŸ”´ **ìµœìš°ì„ : ì•Œë ˆë¥´ê¸° í™•ì¸**\n"
                "1. 'ì‚¬ìš©ì ì„ í˜¸ë„ ì¡°íšŒ' ë„êµ¬ë¥¼ **ë°˜ë“œì‹œ ë¨¼ì €** ì‚¬ìš©í•˜ì—¬ ì•Œë ˆë¥´ê¸° ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.\n"
                "2. ì•Œë ˆë¥´ê¸° ì‹ì¬ë£Œê°€ í¬í•¨ëœ ë©”ë‰´ëŠ” ì ˆëŒ€ ì¶”ì²œí•˜ì§€ ë§ˆì„¸ìš”!\n\n"
                "ğŸ“Š **Notion ë°ì´í„° ë¶„ì„**\n"
                "3. 'ì‹ë‹¨ ê¸°ë¡ ì¡°íšŒ' ë„êµ¬ë¡œ ìµœê·¼ 7ì¼ê°„ ì‹ë‹¨ì„ ë¶„ì„í•˜ì„¸ìš”.\n"
                "4. ë¶€ì¡±í•œ ì˜ì–‘ì†Œë¥¼ íŒŒì•…í•˜ê³  ë³´ì™„ ë°©í–¥ì„ ì œì‹œí•˜ì„¸ìš”.\n\n"
                "ğŸ¯ **ê°œì¸í™”ëœ ì¶”ì²œ**\n"
                "5. ì‚¬ìš©ìì˜ ì„ í˜¸ ìŒì‹ ì¢…ë¥˜ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ê³ ë ¤í•˜ì„¸ìš”.\n"
                "6. ë‹¤ì´ì–´íŠ¸ ëª©í‘œì— ë§ëŠ” ì¹¼ë¡œë¦¬ ë²”ìœ„ì˜ ë©”ë‰´ë¥¼ ì„ ì •í•˜ì„¸ìš”.\n"
                "7. 'ë©”ë‰´ ê²€ìƒ‰' ë„êµ¬ë¡œ ì˜ì–‘í•™ì ìœ¼ë¡œ ì í•©í•œ ë©”ë‰´ í›„ë³´ë¥¼ ì°¾ìœ¼ì„¸ìš”.\n"
                "8. ê±´ê°• ê´€ì ì—ì„œ ìµœì ì˜ ë©”ë‰´ 3-5ê°œë¥¼ ì„ ì •í•˜ê³  Notion ë°ì´í„° ê¸°ë°˜ ì´ìœ ë¥¼ ì„¤ëª…í•˜ì„¸ìš”."
            ),
            expected_output=(
                "ì˜ì–‘í•™ì ìœ¼ë¡œ ì í•©í•œ ë©”ë‰´ 3-5ê°œ ëª©ë¡ê³¼ ê° ë©”ë‰´ì— ëŒ€í•œ í‰ê°€ (ì¹¼ë¡œë¦¬, ì˜ì–‘ì†Œ, ì•Œë ˆë¥´ê¸° ì²´í¬)"
            ),
            agent=self.nutrition_agent,
        )
        
        # Task 2: ì˜ˆì‚° ê´€ë¦¬ì - ê°€ì„±ë¹„ ë¶„ì„ (Notion ë°ì´í„° ê¸°ë°˜)
        budget_task = Task(
            description=(
                f"ì‚¬ìš©ì ìš”ì²­: {user_request}\n\n"
                "ğŸ’° **Notion ì˜ˆì‚° ë°ì´í„° í™•ì¸**\n"
                "1. 'ì˜ˆì‚° í˜„í™© ì¡°íšŒ' ë„êµ¬ë¥¼ **ë°˜ë“œì‹œ ë¨¼ì €** ì‚¬ìš©í•˜ì—¬ Notionì—ì„œ ì˜ˆì‚° ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì„¸ìš”.\n"
                "2. ë‚¨ì€ ì˜ˆì‚°ê³¼ ì„ í˜¸ ê°€ê²©ëŒ€ë¥¼ í™•ì¸í•˜ì„¸ìš”.\n\n"
                "ğŸ”’ **ì˜ˆì‚° ë²”ìœ„ ì—„ìˆ˜**\n"
                "3. ë‚¨ì€ ì˜ˆì‚°ì„ ì ˆëŒ€ ì´ˆê³¼í•˜ì§€ ì•ŠëŠ” ë©”ë‰´ë§Œ ì„ ì •í•˜ì„¸ìš”.\n"
                "4. ì„ í˜¸ ê°€ê²©ëŒ€ ë²”ìœ„ ë‚´ì˜ ë©”ë‰´ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ê³ ë ¤í•˜ì„¸ìš”.\n\n"
                "ğŸ“Š **ê°€ì„±ë¹„ í‰ê°€**\n"
                "5. 'ë©”ë‰´ ê²€ìƒ‰' ë„êµ¬ë¡œ ì˜ˆì‚° ë²”ìœ„ ë‚´ ë©”ë‰´ë¥¼ ì°¾ìœ¼ì„¸ìš”.\n"
                "6. ê°€ê²© ëŒ€ë¹„ ì¹¼ë¡œë¦¬, ì˜ì–‘ê°€, ì–‘, ë§Œì¡±ë„ë¥¼ ì¢…í•© í‰ê°€í•˜ì„¸ìš”.\n"
                "7. ìµœê³ ì˜ ê°€ì„±ë¹„ë¥¼ ìë‘í•˜ëŠ” ë©”ë‰´ 3-5ê°œë¥¼ ì¶”ì²œí•˜ê³  Notion ì˜ˆì‚° ë°ì´í„° ê¸°ë°˜ ì´ìœ ë¥¼ ì„¤ëª…í•˜ì„¸ìš”."
            ),
            expected_output=(
                "ê°€ì„±ë¹„ ì¢‹ì€ ë©”ë‰´ 3-5ê°œ ëª©ë¡ê³¼ ê° ë©”ë‰´ì˜ ê°€ê²©, ê°€ì„±ë¹„ í‰ê°€"
            ),
            agent=self.budget_agent,
        )
        
        # Task 3: ì‹œê°„ ê´€ë¦¬ì - ì‹œê°„ íš¨ìœ¨ì„± ë¶„ì„ (Notion ë°ì´í„° ê¸°ë°˜)
        scheduler_task = Task(
            description=(
                f"ì‚¬ìš©ì ìš”ì²­: {user_request}\n\n"
                "â° **Notion ì¼ì • ë°ì´í„° í™•ì¸**\n"
                "1. 'ì‚¬ìš©ì ì¼ì • ì¡°íšŒ' ë„êµ¬ë¥¼ **ë°˜ë“œì‹œ ë¨¼ì €** ì‚¬ìš©í•˜ì—¬ Notionì—ì„œ ê°€ìš© ì‹œê°„ì„ ê°€ì ¸ì˜¤ì„¸ìš”.\n"
                "2. ì‹ì‚¬ ì‹œê°„ëŒ€ì™€ ê°€ìš© ì‹œê°„(ë¶„)ì„ ì •í™•íˆ íŒŒì•…í•˜ì„¸ìš”.\n\n"
                "ğŸ”’ **ì‹œê°„ ì œì•½ ì—„ìˆ˜**\n"
                "3. ê°€ìš© ì‹œê°„ì„ ì ˆëŒ€ ì´ˆê³¼í•˜ì§€ ì•ŠëŠ” ë©”ë‰´ë§Œ ì„ ì •í•˜ì„¸ìš”.\n"
                "4. 15ë¶„ ì´í•˜: ì¦‰ì„ ì¡°ë¦¬/ë°°ë‹¬/ê°„í¸ì‹ë§Œ ì¶”ì²œ\n"
                "5. 30ë¶„ ì´í•˜: ê°„ë‹¨ ì¡°ë¦¬ ë˜ëŠ” ë¹ ë¥¸ ë°°ë‹¬ ë©”ë‰´ ì¶”ì²œ\n\n"
                "âš¡ **ì‹œê°„ íš¨ìœ¨ì„± í‰ê°€**\n"
                "6. 'ë©”ë‰´ ê²€ìƒ‰' ë„êµ¬ë¡œ ì‹œê°„ ë²”ìœ„ ë‚´ ë©”ë‰´ë¥¼ ì°¾ìœ¼ì„¸ìš”.\n"
                "7. ì¡°ë¦¬/ë°°ë‹¬ ì‹œê°„ì´ ì§§ì€ ìˆœì„œëŒ€ë¡œ ì •ë ¬í•˜ì„¸ìš”.\n"
                "8. ì‹œê°„ íš¨ìœ¨ì„±ì´ ë†’ì€ ë©”ë‰´ 3-5ê°œë¥¼ ì¶”ì²œí•˜ê³  Notion ì¼ì • ë°ì´í„° ê¸°ë°˜ ì´ìœ ë¥¼ ì„¤ëª…í•˜ì„¸ìš”."
            ),
            expected_output=(
                "ì‹œê°„ ë‚´ ì¤€ë¹„ ê°€ëŠ¥í•œ ë©”ë‰´ 3-5ê°œì™€ ê° ë©”ë‰´ì˜ ì˜ˆìƒ ì†Œìš” ì‹œê°„"
            ),
            agent=self.scheduler_agent,
        )
        
        # Task 4: ìš”ë¦¬ì‚¬ - ì§‘ë°¥ ë ˆì‹œí”¼ ì¶”ì²œ
        chef_task = Task(
            description=(
                f"ì‚¬ìš©ì ìš”ì²­: {user_request}\n\n"
                "1. ì‚¬ìš©ìì˜ ìš”ë¦¬ ì‹¤ë ¥ê³¼ ì„ í˜¸ë„ë¥¼ í™•ì¸í•˜ì„¸ìš”.\n"
                "2. ì§‘ì—ì„œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ë ˆì‹œí”¼ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”.\n"
                "3. ë‚œì´ë„ì™€ ì¡°ë¦¬ ì‹œê°„ì„ ê³ ë ¤í•˜ì—¬ ì‹¤í–‰ ê°€ëŠ¥í•œ ë ˆì‹œí”¼ë¥¼ ì„ ë³„í•˜ì„¸ìš”.\n"
                "4. ì¶”ì²œí•˜ëŠ” ì§‘ë°¥ ë ˆì‹œí”¼ 2-3ê°œë¥¼ ì¬ë£Œ, ì¡°ë¦¬ë²•ê³¼ í•¨ê»˜ ì œì‹œí•˜ì„¸ìš”.\n"
                "5. ì§‘ë°¥ì˜ ì¥ì  (ì €ë ´í•¨, ê±´ê°•í•¨, ë§› ì¡°ì ˆ ê°€ëŠ¥)ì„ ê°•ì¡°í•˜ì„¸ìš”."
            ),
            expected_output=(
                "ì§‘ë°¥ ë ˆì‹œí”¼ 2-3ê°œì™€ ê° ë ˆì‹œí”¼ì˜ ì¬ë£Œ, ì¡°ë¦¬ ì‹œê°„, ë‚œì´ë„"
            ),
            agent=self.chef_agent,
        )
        
        # Task 5: ë§›ìŠë­ - ë§› í‰ê°€
        taste_task = Task(
            description=(
                f"ì‚¬ìš©ì ìš”ì²­: {user_request}\n\n"
                "1. ì‚¬ìš©ìì˜ ìŒì‹ ì„ í˜¸ë„ (í•œì‹/ì¼ì‹ ì„ í˜¸, ë§¤ìš´ë§› ì •ë„ ë“±)ë¥¼ í™•ì¸í•˜ì„¸ìš”.\n"
                "2. ë©”ë‰´ë¥¼ ê²€ìƒ‰í•˜ì—¬ í‰ì ì´ ë†’ê³  ë¦¬ë·°ê°€ ë§ì€ ë ˆìŠ¤í† ë‘ì„ ì°¾ìœ¼ì„¸ìš”.\n"
                "3. ê° ë©”ë‰´ì˜ ë§› íŠ¹ì§• (ë§¤ìš´ë§›, ë‹¨ë§›, ì§ ë§› ë“±)ì„ ë¶„ì„í•˜ì„¸ìš”.\n"
                "4. í‰ì ê³¼ ë¦¬ë·°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë§›ì˜ í’ˆì§ˆì´ ìš°ìˆ˜í•œ ë©”ë‰´ 3-5ê°œë¥¼ ì¶”ì²œí•˜ì„¸ìš”.\n"
                "5. ê° ë©”ë‰´ê°€ ì™œ ë§›ìˆëŠ”ì§€ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•˜ì„¸ìš”."
            ),
            expected_output=(
                "ë§›ì´ ë›°ì–´ë‚œ ë©”ë‰´ 3-5ê°œì™€ ê° ë©”ë‰´ì˜ í‰ì , ë§› íŠ¹ì§•, ì¶”ì²œ ì´ìœ "
            ),
            agent=self.taste_agent,
        )
        
        # Task 6: ì½”ë””ë„¤ì´í„° - ìµœì¢… ì¢…í•© íŒë‹¨ (Notion ë°ì´í„° ê¸°ë°˜)
        coordinator_task = Task(
            description=(
                f"ì‚¬ìš©ì ìš”ì²­: {user_request}\n\n"
                "ğŸ¯ **Notion ì‹¤ì‹œê°„ ë°ì´í„° ê¸°ë°˜ ì¢…í•© íŒë‹¨**\n"
                "ë‹¤ìŒ ì „ë¬¸ê°€ë“¤ì´ Notionì—ì„œ ê°€ì ¸ì˜¨ ê°œì¸í™” ë°ì´í„°ë¥¼ ë¶„ì„í–ˆìŠµë‹ˆë‹¤:\n"
                "- ì˜ì–‘ì‚¬: Notion ì•Œë ˆë¥´ê¸°/ì„ í˜¸ë„/ì‹ë‹¨ ê¸°ë¡ ë¶„ì„\n"
                "- ì´ë¬´: Notion ì˜ˆì‚° í˜„í™© ë¶„ì„\n"
                "- ìŠ¤ì¼€ì¤„ëŸ¬: Notion ì¼ì • ë° ê°€ìš© ì‹œê°„ ë¶„ì„\n"
                "- ìš”ë¦¬ì‚¬: ì§‘ë°¥ ë ˆì‹œí”¼ ì œì•ˆ\n"
                "- ë§›ìŠë­: ë§› í‰ê°€\n\n"
                "ğŸ”´ **ì ˆëŒ€ ì›ì¹™**\n"
                "1. ì•Œë ˆë¥´ê¸° ì‹ì¬ë£Œê°€ í¬í•¨ëœ ë©”ë‰´ëŠ” ì ˆëŒ€ ì¶”ì²œ ê¸ˆì§€\n"
                "2. ê°€ìš© ì‹œê°„ì„ ì´ˆê³¼í•˜ëŠ” ë©”ë‰´ëŠ” ì ˆëŒ€ ì¶”ì²œ ê¸ˆì§€\n"
                "3. ë‚¨ì€ ì˜ˆì‚°ì„ ì´ˆê³¼í•˜ëŠ” ë©”ë‰´ëŠ” ì ˆëŒ€ ì¶”ì²œ ê¸ˆì§€\n\n"
                "âš–ï¸ **ê°€ì¤‘ì¹˜ ì ìš© ì¢…í•© í‰ê°€**\n"
                "4. ê° ì „ë¬¸ê°€ì˜ ì˜ê²¬ì— ë‹¤ìŒ ê°€ì¤‘ì¹˜ë¥¼ ì ìš©í•˜ì„¸ìš”:\n"
                "   - ì˜ì–‘ì‚¬: 30% (ì•Œë ˆë¥´ê¸° ì•ˆì „ + ê±´ê°•)\n"
                "   - ì´ë¬´: 25% (ì˜ˆì‚° ì¤€ìˆ˜ + ê°€ì„±ë¹„)\n"
                "   - ë§›ìŠë­: 20% (ë§›ê³¼ ë§Œì¡±ë„)\n"
                "   - ìŠ¤ì¼€ì¤„ëŸ¬: 15% (ì‹œê°„ ì œì•½ ì¤€ìˆ˜)\n"
                "   - ìš”ë¦¬ì‚¬: 10% (ì§‘ë°¥ ì‹¤ìš©ì„±)\n\n"
                "âœ… **ìµœì¢… ì¶”ì²œ ì„ ì •**\n"
                "5. 'ìµœìš°ì„  ì¶”ì²œ(1ì•ˆ)': ì¢…í•© ì ìˆ˜ê°€ ê°€ì¥ ë†’ì€ ë©”ë‰´\n"
                "6. 'ëŒ€ì•ˆ ì¶”ì²œ(2ì•ˆ)': 1ì•ˆê³¼ ë‹¤ë¥¸ íŠ¹ì„±ì„ ê°€ì§„ ìš°ìˆ˜ ë©”ë‰´\n"
                "7. ê° ì¶”ì²œì— ë°˜ë“œì‹œ í¬í•¨í•  ì •ë³´:\n"
                "   - ë©”ë‰´ëª…, ë ˆìŠ¤í† ë‘/ë ˆì‹œí”¼, ê°€ê²©, ì¹¼ë¡œë¦¬, ì¡°ë¦¬/ë°°ë‹¬ ì‹œê°„\n"
                "   - ì„ ì • ì´ìœ  (ê° ì „ë¬¸ê°€ì˜ Notion ë°ì´í„° ê¸°ë°˜ í‰ê°€)\n"
                "   - ì£¼ì˜ì‚¬í•­ (ì•Œë ˆë¥´ê¸°, ì‹œê°„, ì˜ˆì‚° ê´€ë ¨)"
            ),
            expected_output=(
                "ìµœì¢… ì¶”ì²œ ê²°ê³¼:\n"
                "1. ìµœìš°ì„  ì¶”ì²œ (1ì•ˆ): [ìƒì„¸ ì •ë³´ ë° ì„ ì • ì´ìœ ]\n"
                "2. ëŒ€ì•ˆ ì¶”ì²œ (2ì•ˆ): [ìƒì„¸ ì •ë³´ ë° ì„ ì • ì´ìœ ]"
            ),
            agent=self.coordinator_agent,
            context=[nutrition_task, budget_task, scheduler_task, chef_task, taste_task]
        )
        
        return [
            nutrition_task,
            budget_task,
            scheduler_task,
            chef_task,
            taste_task,
            coordinator_task
        ]
    
    def create_restaurant_delivery_tasks(self, user_request: str) -> list[Task]:
        """ì™¸ì‹/ë°°ë‹¬ ì¶”ì²œì„ ìœ„í•œ íƒœìŠ¤í¬ ìƒì„± (ì‹ë‹¹_DB.json í™œìš©)"""
        
        # Task 1: ì˜ˆì‚° ê´€ë¦¬ì - ì˜ˆì‚° ê¸°ë°˜ ë ˆìŠ¤í† ë‘ ê²€ìƒ‰
        budget_task = Task(
            description=(
                f"ì‚¬ìš©ì ìš”ì²­: {user_request}\n\n"
                "ğŸ’° **Notion ì˜ˆì‚° ë°ì´í„° í™•ì¸**\n"
                "1. 'ì˜ˆì‚° í˜„í™© ì¡°íšŒ' ë„êµ¬ë¥¼ **ë°˜ë“œì‹œ ë¨¼ì €** ì‚¬ìš©í•˜ì—¬ Notionì—ì„œ ì˜ˆì‚° ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì„¸ìš”.\n"
                "2. ë‚¨ì€ ì˜ˆì‚°ê³¼ ì„ í˜¸ ê°€ê²©ëŒ€ë¥¼ í™•ì¸í•˜ì„¸ìš”.\n\n"
                "ğŸ½ï¸ **ì‹ë‹¹_DB.jsonì—ì„œ ê°€ì„±ë¹„ ë ˆìŠ¤í† ë‘ ê²€ìƒ‰**\n"
                "3. 'ì˜ˆì‚° ìµœì í™” ë ˆìŠ¤í† ë‘ ì¶”ì²œ' ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜ˆì‚° ë‚´ ê°€ì„±ë¹„ ì¢‹ì€ ë ˆìŠ¤í† ë‘ì„ ì°¾ìœ¼ì„¸ìš”.\n"
                "4. í•„ìš”ì‹œ 'ë ˆìŠ¤í† ë‘ ê²€ìƒ‰ (ì˜ˆì‚° ë° ì‹œê°„ ê¸°ë°˜)' ë„êµ¬ë¡œ ì¶”ê°€ ê²€ìƒ‰:\n"
                "   - âš ï¸ keywordëŠ” ì„ íƒ ì‚¬í•­! í•„ìš”ì‹œë§Œ ì‚¬ìš©\n"
                "   - ì˜ˆ: search_restaurants(max_budget=15000, max_time_minutes=30)\n"
                "   - âš ï¸ ìµœëŒ€ 2íšŒë§Œ í˜¸ì¶œ! ê²°ê³¼ ì—†ìœ¼ë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ\n\n"
                "âœ… **ì¶œë ¥ ìš”êµ¬ì‚¬í•­**\n"
                "5. ì˜ˆì‚° ë‚´ì—ì„œ ê°€ì„±ë¹„ê°€ ì¢‹ì€ ë ˆìŠ¤í† ë‘ 3-5ê°œë¥¼ ì„ ì •í•˜ì„¸ìš”.\n"
                "6. ê° ë ˆìŠ¤í† ë‘ì˜ ì¶”ì²œ ë©”ë‰´ì™€ ê°€ê²©ì„ ëª…ì‹œí•˜ì„¸ìš”.\n"
                "7. **ì¤‘ìš”**: ì‹ë‹¹_DB.jsonì— ìˆëŠ” ì‹¤ì œ ë ˆìŠ¤í† ë‘ë§Œ ì¶”ì²œí•´ì•¼ í•©ë‹ˆë‹¤.\n"
                "8. ì˜ˆì‚°ì„ ì´ˆê³¼í•˜ëŠ” ë©”ë‰´ëŠ” ì ˆëŒ€ ì¶”ì²œí•˜ì§€ ë§ˆì„¸ìš”."
            ),
            expected_output=(
                "ì˜ˆì‚° ë‚´ ê°€ì„±ë¹„ ì¢‹ì€ ë ˆìŠ¤í† ë‘ 3-5ê°œ ëª©ë¡:\n"
                "- ë ˆìŠ¤í† ë‘ëª…\n"
                "- ì¶”ì²œ ë©”ë‰´ ë° ê°€ê²©\n"
                "- í‰ê·  ë©”ë‰´ ê°€ê²©\n"
                "- ê°€ì„±ë¹„ í‰ê°€"
            ),
            agent=self.budget_agent,
        )
        
        # Task 2: ì¼ì • ê´€ë¦¬ì - ì‹œê°„ ê¸°ë°˜ ë ˆìŠ¤í† ë‘ í•„í„°ë§
        scheduler_task = Task(
            description=(
                f"ì‚¬ìš©ì ìš”ì²­: {user_request}\n\n"
                "â° **Notion ì¼ì • ë°ì´í„° í™•ì¸**\n"
                "1. 'ì‚¬ìš©ì ì¼ì • ì¡°íšŒ' ë„êµ¬ë¥¼ **ë°˜ë“œì‹œ ë¨¼ì €** ì‚¬ìš©í•˜ì—¬ Notionì—ì„œ ê°€ìš© ì‹œê°„ì„ ê°€ì ¸ì˜¤ì„¸ìš”.\n"
                "2. ì‹ì‚¬ ì‹œê°„ëŒ€ì™€ ê°€ìš© ì‹œê°„(ë¶„)ì„ ì •í™•íˆ íŒŒì•…í•˜ì„¸ìš”.\n\n"
                "ğŸ½ï¸ **ì‹œê°„ ì œì•½ ê³ ë ¤í•œ ë ˆìŠ¤í† ë‘ ê²€ìƒ‰**\n"
                "3. 'ë ˆìŠ¤í† ë‘ ê²€ìƒ‰ (ì˜ˆì‚° ë° ì‹œê°„ ê¸°ë°˜)' ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹œê°„ ë‚´ ê°€ëŠ¥í•œ ë ˆìŠ¤í† ë‘ì„ ì°¾ìœ¼ì„¸ìš”.\n"
                "   - ë°°ë‹¬ì„ ì›í•˜ë©´: meal_type='ë°°ë‹¬'\n"
                "   - ë§¤ì¥ ì‹ì‚¬ë¥¼ ì›í•˜ë©´: meal_type='ë§¤ì¥'\n"
                "   - âš ï¸ keywordëŠ” ì„ íƒ ì‚¬í•­! í•„ìš”ì‹œë§Œ ì‚¬ìš©\n"
                "   - ì˜ˆ: search_restaurants(max_budget=20000, max_time_minutes=30, meal_type='ë°°ë‹¬')\n"
                "   - âš ï¸ ìµœëŒ€ 2íšŒë§Œ í˜¸ì¶œ! ê²°ê³¼ ì—†ìœ¼ë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ\n"
                "4. ê°€ìš© ì‹œê°„ì„ ì´ˆê³¼í•˜ëŠ” ë ˆìŠ¤í† ë‘ì€ ì œì™¸í•˜ì„¸ìš”.\n\n"
                "âœ… **ì¶œë ¥ ìš”êµ¬ì‚¬í•­**\n"
                "5. ì‹œê°„ ë‚´ì— ì´ìš© ê°€ëŠ¥í•œ ë ˆìŠ¤í† ë‘ 3-5ê°œë¥¼ ì„ ì •í•˜ì„¸ìš”.\n"
                "6. ê° ë ˆìŠ¤í† ë‘ì˜ ì˜ˆìƒ ì†Œìš”ì‹œê°„ì„ ëª…ì‹œí•˜ì„¸ìš”.\n"
                "7. ë¹ ë¥¸ ìˆœì„œëŒ€ë¡œ ì •ë ¬í•˜ì„¸ìš”."
            ),
            expected_output=(
                "ì‹œê°„ ë‚´ ì´ìš© ê°€ëŠ¥í•œ ë ˆìŠ¤í† ë‘ 3-5ê°œ ëª©ë¡:\n"
                "- ë ˆìŠ¤í† ë‘ëª…\n"
                "- ë°°ë‹¬/ë§¤ì¥ ì˜ˆìƒ ì†Œìš”ì‹œê°„\n"
                "- ì¶”ì²œ ì´ìœ "
            ),
            agent=self.scheduler_agent,
            context=[budget_task]
        )
        
        # Task 3: ì˜ì–‘ì‚¬ - ì‚¬ìš©ì ê±´ê°• ì •ë³´ ìˆ˜ì§‘ ë° ì˜ì–‘ ê°€ì´ë“œë¼ì¸ ì œê³µ
        nutrition_task = Task(
            description=(
                f"ì‚¬ìš©ì ìš”ì²­: {user_request}\n\n"
                "ë‹¹ì‹ ì€ ì˜ì–‘ì‚¬ì…ë‹ˆë‹¤. ì´ì „ ì—ì´ì „íŠ¸(ì˜ˆì‚°, ì¼ì •)ê°€ ì°¾ì€ ë ˆìŠ¤í† ë‘ í›„ë³´ë“¤ì„ í‰ê°€í•˜ì„¸ìš”.\n\n"
                
                "**ì‘ì—… ìˆœì„œ:**\n"
                "1. 'ì‚¬ìš©ì ì„ í˜¸ë„ ì¡°íšŒ' ë„êµ¬ë¥¼ 1íšŒë§Œ ì‚¬ìš©í•˜ì—¬ ì•Œë ˆë¥´ê¸°, ì‹ì´ ì œí•œ í™•ì¸\n"
                "2. 'ì‹ë‹¨ ê¸°ë¡ ì¡°íšŒ' ë„êµ¬ë¥¼ 1íšŒë§Œ ì‚¬ìš©í•˜ì—¬ ìµœê·¼ ì‹ë‹¨ í™•ì¸\n"
                "3. ì´ì „ ì—ì´ì „íŠ¸ë“¤ì´ ì¶”ì²œí•œ ë ˆìŠ¤í† ë‘ ëª©ë¡ì„ ë³´ê³ :\n"
                "   - ì•Œë ˆë¥´ê¸° ìœ„í—˜ ë ˆìŠ¤í† ë‘ í‘œì‹œ\n"
                "   - ì±„ì‹ì£¼ì˜ìì—ê²Œ ë¶€ì í•©í•œ ë ˆìŠ¤í† ë‘ í‘œì‹œ (ê³ ê¸°ì§‘ ë“±)\n"
                "   - ê±´ê°• ê´€ì ì—ì„œ ì¶”ì²œ/ë¹„ì¶”ì²œ ì˜ê²¬ ì œì‹œ\n"
                "4. ì‘ì—… ì™„ë£Œ\n\n"
                
                "âš ï¸ **ì¤‘ìš”: ë„êµ¬ëŠ” ì •í™•íˆ 2ê°œë§Œ ì‚¬ìš©í•˜ì„¸ìš”**\n"
                "- ì„ í˜¸ë„ ì¡°íšŒ (1íšŒ)\n"
                "- ì‹ë‹¨ ê¸°ë¡ ì¡°íšŒ (1íšŒ)\n"
                "- ë ˆìŠ¤í† ë‘ ê²€ìƒ‰ì€ í•˜ì§€ ë§ˆì„¸ìš”! (ì´ë¯¸ ì´ì „ ì—ì´ì „íŠ¸ê°€ í–ˆìŒ)\n"
                "- ì¶”ê°€ ë„êµ¬ í˜¸ì¶œ ê¸ˆì§€!"
            ),
            expected_output=(
                "ê±´ê°• ë° ì˜ì–‘ ê´€ì  í‰ê°€:\n"
                "- ì•Œë ˆë¥´ê¸°: [ì•Œë ˆë¥´ê¸° ì •ë³´]\n"
                "- ì‹ì´ ì œí•œ: [ì±„ì‹, ê±´ê°• ìƒíƒœ ë“±]\n"
                "- ì¶”ì²œ ê°€ëŠ¥: [ì•ˆì „í•œ ë ˆìŠ¤í† ë‘ ëª©ë¡]\n"
                "- ì œì™¸ í•„ìš”: [ìœ„í—˜í•œ ë ˆìŠ¤í† ë‘ê³¼ ì´ìœ ]\n"
                "- ì˜ì–‘ ì¡°ì–¸: [ë¶€ì¡±í•œ ì˜ì–‘ì†Œ, ê¶Œì¥ì‚¬í•­]"
            ),
            agent=self.nutrition_agent,
            context=[budget_task, scheduler_task]
        )
        
        # Task 4: ë§›ìŠë­ - ìµœì¢… ë ˆìŠ¤í† ë‘ ì¶”ì²œ (desc/menu ì ê·¹ í™œìš©)
        taste_task = Task(
            description=(
                f"ì‚¬ìš©ì ìš”ì²­: {user_request}\n\n"
                "ğŸ” **ì´ì „ ì—ì´ì „íŠ¸ ë¶„ì„ ì¢…í•©**\n"
                "1. ì˜ˆì‚° ê´€ë¦¬ì, ì¼ì • ê´€ë¦¬ì, ì˜ì–‘ì‚¬ì˜ ì¶”ì²œì„ ëª¨ë‘ ê²€í† í•˜ì„¸ìš”.\n"
                "2. ê³µí†µì ìœ¼ë¡œ ì¶”ì²œëœ ë ˆìŠ¤í† ë‘ì„ ìš°ì„  ê³ ë ¤í•˜ì„¸ìš”.\n"
                "3. ì˜ì–‘ì‚¬ê°€ ì œì™¸í•œ ë ˆìŠ¤í† ë‘ (ê³ ê¸°ì§‘, ê±´ê°•ì— ì•ˆ ì¢‹ì€ ì‹ë‹¹)ì€ ì ˆëŒ€ ì¶”ì²œí•˜ì§€ ë§ˆì„¸ìš”.\n\n"
                "ğŸ½ï¸ **ë ˆìŠ¤í† ë‘ ìƒì„¸ ì •ë³´ í™•ì¸ ë° desc ë¶„ì„**\n"
                "4. 'ë ˆìŠ¤í† ë‘ ìƒì„¸ ì •ë³´ ì¡°íšŒ' ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¶”ì²œ í›„ë³´ì˜ ì „ì²´ ë©”ë‰´ì™€ ì„¤ëª…ì„ í™•ì¸í•˜ì„¸ìš”.\n"
                "5. ì‹ë‹¹ ì„¤ëª…(desc)ì„ ê¼¼ê¼¼íˆ ë¶„ì„:\n"
                "   - 'ì¸ê¸° ë©”ë‰´', 'ëŒ€í‘œ ë©”ë‰´', 'ì¶”ì²œ ë©”ë‰´' í‚¤ì›Œë“œ ì°¾ê¸°\n"
                "   - 'ìœ ëª…í•œ', 'ë§›ìˆëŠ”', 'ì „ë¬¸ì ', 'ì¸ê¸°', 'ì†Œë¬¸ë‚œ' ë“± í’ˆì§ˆ ì§€í‘œ í™•ì¸\n"
                "   - íŠ¹ì§•ì ì¸ ì¡°ë¦¬ë²•ì´ë‚˜ ì¬ë£Œ ì •ë³´ íŒŒì•…\n"
                "   - ì‚¬ìš©ì ìš”ì²­ê³¼ ì—°ê´€ëœ í‚¤ì›Œë“œ ë§¤ì¹­ (ì˜ˆ: 'ì–¼í°í•œ' â†’ 'ë§¤ìš´', 'ì¹¼ì¹¼')\n\n"
                "ğŸ’¡ **desc í™œìš© ì¶”ì²œ ë©˜íŠ¸ ì‘ì„±**\n"
                "6. descì—ì„œ ê°€ì¥ ë§¤ë ¥ì ì¸ ë¬¸ì¥ì´ë‚˜ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•˜ì„¸ìš”.\n"
                "7. ì¶”ì²œ ë©˜íŠ¸ì— descì˜ í•µì‹¬ ë‚´ìš©ì„ ì¸ìš©í•˜ì—¬ ì„¤ë“ë ¥ ìˆê²Œ ì‘ì„±:\n"
                "   ì˜ˆ: 'í•´ë¬¼íŒŒì „ê³¼ í•´ë¬¼ì¹¼êµ­ìˆ˜, ê·¸ë‚ ê·¸ë‚  ë“¤ì–´ì˜¤ëŠ” ì‹ ì„ í•œ í•´ë¬¼ì„ ì‚¬ìš©í•˜ì—¬...'\n"
                "   ì˜ˆ: 'ì •ë™ì§„ ê´€ê´‘ì§€ ê·¼ì²˜ì˜ ë§ì¹˜ë§¤ìš´íƒ• ì „ë¬¸ì ìœ¼ë¡œ, ì´ìƒ‰ ì–´ì¢…ì¸ ë§ì¹˜ë¡œ...'\n\n"
                "ğŸ‘¤ **ì‚¬ìš©ì ì„ í˜¸ë„ ë°˜ì˜**\n"
                "8. 'ì‚¬ìš©ì ì„ í˜¸ë„ ì¡°íšŒ' ë„êµ¬ë¡œ ì„ í˜¸ ìŒì‹ ì¢…ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.\n"
                "9. 'ì‹ë‹¨ ê¸°ë¡ ì¡°íšŒ' ë„êµ¬ë¡œ ê³¼ê±° ì„ í˜¸ íŒ¨í„´ì„ íŒŒì•…í•˜ì„¸ìš”.\n"
                "10. ì‚¬ìš©ìì˜ ë§› ì„ í˜¸ë„ (ë§¤ìš´ë§›, ë‹¨ë§› ë“±)ì— ë§ëŠ” ë ˆìŠ¤í† ë‘ì„ ì„ ì •í•˜ì„¸ìš”.\n\n"
                "ğŸ¤– **LLM as Judge - ê°œì¸í™” ìµœì¢… í™•ì¸**\n"
                "11. ìµœì¢… í›„ë³´ë¥¼ ì„ ì •í•œ í›„, 'ë©”ë‰´ ê°œì¸í™” ì í•©ì„± íŒë‹¨' ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.\n"
                "   - ì˜ì–‘ì‚¬ê°€ ì´ë¯¸ íŒë‹¨í–ˆì§€ë§Œ, ë§› ì¤‘ì‹¬ìœ¼ë¡œ ì¶”ê°€í•œ ë©”ë‰´ê°€ ìˆë‹¤ë©´ ì¬í™•ì¸ í•„ìš”\n"
                "12. LLM íŒë‹¨ ê²°ê³¼ê°€ 'âŒ ë¶€ì í•©'ì¸ ë©”ë‰´ëŠ” ì¦‰ì‹œ ì œì™¸í•˜ì„¸ìš”.\n\n"
                "ğŸ¯ **ìµœì¢… ì¶”ì²œ ì„ ì •**\n"
                "13. LLM íŒë‹¨ì„ í†µê³¼í•œ ìµœê³ ì˜ ë ˆìŠ¤í† ë‘ 3-4ê°œë¥¼ ì„ ì •í•˜ì„¸ìš”.\n"
                "14. ê° ë ˆìŠ¤í† ë‘ì˜ ì¶”ì²œ ë©”ë‰´ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì œì‹œí•˜ì„¸ìš”.\n"
                "15. **ë°˜ë“œì‹œ í¬í•¨í•  ì •ë³´**:\n"
                "   - ë ˆìŠ¤í† ë‘ëª… ë° ì„¤ëª… (descì—ì„œ ì¶”ì¶œí•œ ë§¤ë ¥ì ì¸ ë¶€ë¶„)\n"
                "   - ì¶”ì²œ ë©”ë‰´ëª…ê³¼ ê°€ê²©\n"
                "   - ë°°ë‹¬/ë§¤ì¥ ì˜ˆìƒ ì†Œìš”ì‹œê°„\n"
                "   - ì„ ì • ì´ìœ  (ë§›, ì˜ì–‘, ì˜ˆì‚°, ì‹œê°„ ê´€ì  + desc ì¸ìš©)\n"
                "   - ì˜ì—…ì‹œê°„ ë° íœ´ë¬´ì¼ ì •ë³´\n"
                "   - LLM ê°œì¸í™” ì í•©ì„± í™•ì¸ ê²°ê³¼\n\n"
                "âœ¨ **ì‚¬ìš©ì ì¹œí™”ì  ì„¤ëª… (desc ì ê·¹ í™œìš©)**\n"
                "16. ê° ë ˆìŠ¤í† ë‘ì˜ íŠ¹ì§•ì„ descë¥¼ ì¸ìš©í•˜ì—¬ ë§¤ë ¥ì ìœ¼ë¡œ ì„¤ëª…í•˜ì„¸ìš”.\n"
                "17. descì—ì„œ 'ì¸ê¸°', 'ì „ë¬¸', 'ìœ ëª…'ê³¼ ê°™ì€ í‚¤ì›Œë“œê°€ ìˆë‹¤ë©´ ê°•ì¡°í•˜ì„¸ìš”.\n"
                "18. ì‚¬ìš©ìê°€ ìµœì¢… ì„ íƒí•˜ê¸° ì‰½ë„ë¡ ëª…í™•í•œ ë¹„êµ ì •ë³´ë¥¼ ì œê³µí•˜ì„¸ìš”."
            ),
            expected_output=(
                "ğŸ½ï¸ **ìµœì¢… ë ˆìŠ¤í† ë‘ ì¶”ì²œ (2-3ê°œ)**\n\n"
                "ê° ë ˆìŠ¤í† ë‘ì— ëŒ€í•´:\n"
                "1. ë ˆìŠ¤í† ë‘ëª… ë° ê°„ë‹¨í•œ ì†Œê°œ\n"
                "2. ì¶”ì²œ ë©”ë‰´ (ë©”ë‰´ëª…, ê°€ê²©)\n"
                "3. ì˜ˆìƒ ì†Œìš”ì‹œê°„ (ë°°ë‹¬ ë˜ëŠ” ë§¤ì¥)\n"
                "4. ì˜ì—…ì‹œê°„\n"
                "5. ì„ ì • ì´ìœ  (ì¢…í•© í‰ê°€)\n"
                "6. ì£¼ì˜ì‚¬í•­ (ì•Œë ˆë¥´ê¸°, ì˜ˆì‚°, ì‹œê°„ ë“±)\n\n"
                "â€» ì‚¬ìš©ìê°€ ë°”ë¡œ ì£¼ë¬¸/ë°©ë¬¸í•  ìˆ˜ ìˆë„ë¡ êµ¬ì²´ì ì¸ ì •ë³´ ì œê³µ"
            ),
            agent=self.taste_agent,
            context=[budget_task, scheduler_task, nutrition_task]
        )
        
        # Task 5: Coordinator - ìµœì¢… ì¢…í•© íŒë‹¨ ë° ì¶”ì²œ
        coordinator_task = Task(
            description=(
                f"ì‚¬ìš©ì ìš”ì²­: {user_request}\n\n"
                "ğŸ¯ **ìµœì¢… ì˜ì‚¬ê²°ì •ìë¡œì„œ ì¢…í•© íŒë‹¨**\n\n"
                "1. **ëª¨ë“  ì—ì´ì „íŠ¸ ê²°ê³¼ ìˆ˜ì§‘**\n"
                "   - ì˜ˆì‚° ê´€ë¦¬ìì˜ ê°€ì„±ë¹„ ë¶„ì„\n"
                "   - ì¼ì • ê´€ë¦¬ìì˜ ì‹œê°„ ë¶„ì„\n"
                "   - ì˜ì–‘ì‚¬ì˜ ê±´ê°•/ì•Œë ˆë¥´ê¸° ë¶„ì„\n"
                "   - ë§›ìŠë­ì˜ ë§›/í’ˆì§ˆ ë¶„ì„ (ë°˜ë“œì‹œ ë ˆìŠ¤í† ë‘ëª… í¬í•¨!)\n\n"
                "2. **ì‚¬ìš©ì í˜ë¥´ì†Œë‚˜ í™•ì¸**\n"
                "   - 'ì‚¬ìš©ì ì„ í˜¸ë„ ì¡°íšŒ' ë„êµ¬ë¡œ ìµœì¢… í™•ì¸\n"
                "   - ì•Œë ˆë¥´ê¸°, ì‹ì´ ì œí•œ, ê±´ê°• ìƒíƒœ, ì„ í˜¸ë„ ì¬í™•ì¸\n\n"
                "3. **ì¤‘ìš”: ë ˆìŠ¤í† ë‘ëª… ë°˜ë“œì‹œ í¬í•¨**\n"
                "   - ì´ì „ ì—ì´ì „íŠ¸ë“¤(íŠ¹íˆ ë§›ìŠë­)ì´ ì¶”ì²œí•œ ë ˆìŠ¤í† ë‘ì˜ **ì‹¤ì œ ì´ë¦„**ì„ í™•ì¸í•˜ì„¸ìš”\n"
                "   - ì˜ˆ: 'ì‹œê³¨ì‹ë‹¹', 'í•´ë¬¼ì¹¼êµ­ìˆ˜ ì§‘', 'ë§ì¹˜ë§¤ìš´íƒ•' ë“± êµ¬ì²´ì ì¸ ì´ë¦„\n"
                "   - ë§Œì•½ ì§‘ë°¥ ë ˆì‹œí”¼ë¼ë©´ 'ì§‘ë°¥ ë ˆì‹œí”¼'ë¡œ í‘œê¸°\n\n"
                "4. **LLM as Judge - ìµœì¢… ì¢…í•© íŒë‹¨**\n"
                "   - 'ë ˆìŠ¤í† ë‘ ì¶”ì²œ ì¢…í•© íŒë‹¨' ë„êµ¬ ì‚¬ìš©\n"
                "   - íŒŒë¼ë¯¸í„° 1: all_agent_recommendations\n"
                "     * ë°˜ë“œì‹œ 'ë ˆìŠ¤í† ë‘ëª…' í•„ë“œë¥¼ í¬í•¨í•˜ì„¸ìš”!\n"
                "     * ì˜ˆ: {'1ì•ˆ': {'ë©”ë‰´ëª…': 'í•´ë¬¼ì¹¼êµ­ìˆ˜', 'ë ˆìŠ¤í† ë‘ëª…': 'ì‹œê³¨ì‹ë‹¹', 'ê°€ê²©': '5000ì›', ...}}\n"
                "   - íŒŒë¼ë¯¸í„° 2: user_persona_info (ì‚¬ìš©ì ì„ í˜¸ë„ ì¡°íšŒ ê²°ê³¼)\n"
                "   - LLMì´ ëª¨ë“  ì¶”ì²œì„ ê²€í† í•˜ê³  ìµœì¢… 2-3ê°œ ì„ ì •\n\n"
                "5. **ìµœì¢… ì¶”ì²œ ì„ ì • ê¸°ì¤€**\n"
                "   - ì˜ì–‘ì‚¬ ì˜ê²¬ ìµœìš°ì„  (30%): ê±´ê°•/ì•Œë ˆë¥´ê¸° ì•ˆì „\n"
                "   - ì˜ˆì‚° ê´€ë¦¬ì ì˜ê²¬ (25%): ì˜ˆì‚° ì¤€ìˆ˜\n"
                "   - ë§›ìŠë­ ì˜ê²¬ (20%): ë§›ê³¼ í’ˆì§ˆ\n"
                "   - ì¼ì • ê´€ë¦¬ì ì˜ê²¬ (15%): ì‹œê°„ ì¤€ìˆ˜\n"
                "   - êµì§‘í•© ìš°ì„ : ì—¬ëŸ¬ ì—ì´ì „íŠ¸ê°€ ê³µí†µ ì¶”ì²œí•œ ë ˆìŠ¤í† ë‘\n\n"
                "6. **ìµœì¢… ì¶œë ¥ í˜•ì‹**\n"
                "   - 1ìˆœìœ„ ì¶”ì²œ (1ì•ˆ)\n"
                "   - 2ìˆœìœ„ ì¶”ì²œ (ëŒ€ì•ˆ)\n"
                "   - í•„ìš”ì‹œ 3ìˆœìœ„ ì¶”ì²œ\n"
                "   - ê° ì¶”ì²œì— ëŒ€í•´ ìƒì„¸ ì •ë³´ ë° ì¢…í•© íŒë‹¨ ì´ìœ  ì œê³µ"
            ),
            expected_output=(
                "### ğŸ¯ ìµœì¢… ë ˆìŠ¤í† ë‘ ì¶”ì²œ (ì¢…í•© íŒë‹¨)\n\n"
                "#### 1ìˆœìœ„ ì¶”ì²œ (ìµœìš°ì„ )\n"
                "- **ë ˆìŠ¤í† ë‘ëª…**: \n"
                "- **ì¶”ì²œ ë©”ë‰´**: (ë©”ë‰´ëª…, ê°€ê²©)\n"
                "- **ì˜ˆìƒ ì†Œìš”ì‹œê°„**: \n"
                "- **ì˜ì—…ì‹œê°„**: \n"
                "- **ì¢…í•© ì„ ì • ì´ìœ **:\n"
                "  * ì˜ì–‘ì‚¬(30%): [ê±´ê°•/ì•Œë ˆë¥´ê¸° ì•ˆì „]\n"
                "  * ì˜ˆì‚°(25%): [ê°€ì„±ë¹„]\n"
                "  * ë§›(20%): [í’ˆì§ˆ í‰ê°€]\n"
                "  * ì‹œê°„(15%): [ì‹œê°„ ì í•©ì„±]\n"
                "  * LLM íŒë‹¨: [ê°œì¸í™” ì í•©ì„± ìµœì¢… í™•ì¸]\n"
                "- **ì£¼ì˜ì‚¬í•­**: \n\n"
                "#### 2ìˆœìœ„ ì¶”ì²œ (ëŒ€ì•ˆ)\n"
                "[ë™ì¼ í˜•ì‹]\n\n"
                "#### ìµœì¢… ì½”ë©˜íŠ¸\n"
                "ì‚¬ìš©ì í˜ë¥´ì†Œë‚˜ì— ê°€ì¥ ì í•©í•œ ì„ íƒì„ ì œì‹œí•˜ë©°, ëª¨ë“  ì œì•½ì‚¬í•­ì„ ì¤€ìˆ˜í–ˆìŒì„ í™•ì¸"
            ),
            agent=self.coordinator_agent,
            context=[budget_task, scheduler_task, nutrition_task, taste_task]
        )
        
        return [budget_task, scheduler_task, nutrition_task, taste_task, coordinator_task]
    
    def run(self, user_request: str) -> str:
        """
        ë™ì  ì›Œí¬í”Œë¡œìš°ë¡œ í¬ë£¨ ì‹¤í–‰
        1. ì‚¬ìš©ì ì˜ë„ ë¶„ì„
        2. í•„ìš”í•œ ì—ì´ì „íŠ¸ë§Œ ì„ íƒ
        3. ìµœì í™”ëœ íƒœìŠ¤í¬ ì‹¤í–‰
        """
        print(f"\n{'='*80}")
        print(f"ğŸš€ ì‚¬ìš©ì ìš”ì²­: {user_request}")
        print(f"{'='*80}\n")
        
        # 1ë‹¨ê³„: ì‚¬ìš©ì ì˜ë„ ë¶„ì„
        print("ğŸ“Š 1ë‹¨ê³„: ì‚¬ìš©ì ì˜ë„ ë¶„ì„ ì¤‘...\n")
        intent = self.analyze_intent(user_request)
        
        # 2ë‹¨ê³„: ë™ì  íƒœìŠ¤í¬ ìƒì„±
        print("ğŸ”§ 2ë‹¨ê³„: ì›Œí¬í”Œë¡œìš° êµ¬ì„± ì¤‘...\n")
        tasks = self.create_dynamic_tasks(user_request, intent)
        
        # 3ë‹¨ê³„: í•„ìš”í•œ ì—ì´ì „íŠ¸ë§Œ ì„ íƒ
        required_agents_keys = intent.get("required_agents", [])
        active_agents = [self.agent_map[key] for key in required_agents_keys if key in self.agent_map]
        
        # Coordinatorê°€ í•„ìš”í•œ ê²½ìš° ì¶”ê°€ (FULL_RECOMMENDATIONì¼ ë•Œë§Œ)
        workflow_type = intent.get("workflow_type")
        if workflow_type == "FULL_RECOMMENDATION":
            active_agents.append(self.coordinator_agent)
        
        print(f"âœ… í™œì„±í™”ëœ ì—ì´ì „íŠ¸ ìˆ˜: {len(active_agents)}")
        print(f"âœ… ì‹¤í–‰í•  íƒœìŠ¤í¬ ìˆ˜: {len(tasks)}\n")
        
        # 4ë‹¨ê³„: Crew ìƒì„± ë° ì‹¤í–‰
        print("âš™ï¸  3ë‹¨ê³„: ì—ì´ì „íŠ¸ ì‹¤í–‰ ì¤‘...\n")
        print(f"{'='*80}\n")
        
        crew = Crew(
            agents=active_agents,
            tasks=tasks,
            process=Process.sequential,
            verbose=CREW_CONFIG["verbose"],
            memory=CREW_CONFIG["memory"],
        )
        
        # ì‹¤í–‰
        result = crew.kickoff()
        
        # ëŒ€í™” íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
        self.conversation_history.append(f"ì‚¬ìš©ì: {user_request}")
        self.conversation_history.append(f"ì‹œìŠ¤í…œ: {str(result)[:200]}...")  # ì²˜ìŒ 200ìë§Œ ì €ì¥
        
        print(f"\n{'='*80}")
        print("âœ¨ ì™„ë£Œ!")
        print(f"{'='*80}\n")
        
        return result


# í…ŒìŠ¤íŠ¸ìš© ë©”ì¸ í•¨ìˆ˜
if __name__ == "__main__":
    crew = FoodRecommendationCrew()
    result = crew.run("ì˜¤ëŠ˜ ì €ë… ë©”ë‰´ ì¶”ì²œí•´ì¤˜")
    print("\n" + "="*80)
    print("ìµœì¢… ì¶”ì²œ ê²°ê³¼:")
    print("="*80)
    print(result)

