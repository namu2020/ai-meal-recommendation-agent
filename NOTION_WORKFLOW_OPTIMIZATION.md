# Notion MCP 기반 개인화 워크플로우 최적화

## 🎯 최적화 목표

Notion MCP를 통해 가져온 실시간 사용자 데이터를 중심으로 전체 워크플로우를 재설계하여, AI 에이전트들이 개인화된 정보를 최대한 활용하도록 개선했습니다.

## ✅ 완료된 최적화 항목

### 1. MCP 서버 안정화 (JSON-RPC 에러 해결)
**문제점**: MCP 서버에서 print문을 사용하여 stdout에 일반 텍스트를 출력하면서 JSON-RPC 파싱 에러 발생
```
ERROR:mcp.client.stdio:Failed to parse JSONRPC message from server
```

**해결 방법**:
- `mcp_servers/notion_server_real.py`의 모든 print문 제거
- MCP는 JSON-RPC만 stdout에 출력해야 함
- 디버깅이 필요한 경우 stderr 사용 권장

**파일**: `mcp_servers/notion_server_real.py`

---

### 2. Tools 출력 포맷 개선

**문제점**: Tools가 JSON 형태로 데이터를 반환하여 AI 에이전트가 개인화 정보의 중요성을 파악하기 어려움

**해결 방법**: 각 tool의 출력을 구조화하고 개인화 정보를 강조

#### 2.1 `get_user_preferences` (사용자 선호도 조회)
```python
=== 사용자 선호도 정보 (Notion 실시간 데이터) ===

⚠️ **알레르기 (필수 확인!)**: 갑각류
   → 이 식재료가 포함된 메뉴는 절대 추천 금지!

❤️ 선호하는 음식: 분식·매콤 선호 / 튀김·과지방 민감
   → 이 종류의 메뉴를 우선 추천!

🎯 다이어트 목표: 균형잡힌 식단
🌶️ 매운맛 선호도: 보통
👨‍🍳 요리 실력: 중급
```

**핵심 개선**:
- 알레르기 정보를 최상단에 배치하고 경고 표시
- "절대 추천 금지", "우선 추천" 등 명확한 지시
- Notion 실시간 데이터임을 명시

#### 2.2 `get_user_schedule` (사용자 일정 조회)
```python
=== 사용자 일정 정보 (Notion 실시간 데이터) ===

📅 날짜: 2025-10-25
🍽️ 식사 시간: 야간 (23:00-23:15)
⏰ 가용 시간: 15분

⚠️ **매우 긴급!** 15분 이하로 먹을 수 있는 초고속 메뉴만 추천!
   → 배달 음식, 즉석 조리 음식, 간편식 추천
```

**핵심 개선**:
- 15분 이하 등 극도로 짧은 시간 제약을 명확히 표시
- "초고속 메뉴만 추천" 등 강한 지시
- 적절한 메뉴 타입 예시 제공

#### 2.3 `get_budget_status` (예산 현황 조회)
```python
=== 예산 현황 (Notion 실시간 데이터) ===

💰 일일 예산: 20,000원
💸 오늘 지출: 12,000원
💵 남은 예산: 8,000원
📊 선호 가격대: 8,000원 ~ 15,000원

✅ 예산 적당. 10,000원 이하 메뉴 추천

💡 추천: 8,000원 ~ 15,000원 범위 메뉴 우선 추천!
```

**핵심 개선**:
- 남은 예산을 명확히 표시
- 예산 상태에 따른 명확한 지시 (초과, 부족, 여유)
- 선호 가격대 우선 추천 명시

**파일**: `tools/notion_tools.py`

---

### 3. 에이전트 프롬프트 강화

모든 에이전트의 `goal`과 `backstory`를 Notion 데이터 우선 사용 원칙으로 재작성했습니다.

#### 3.1 영양사 에이전트 (`agents/nutrition_agent.py`)
**Goal 개선**:
```
사용자의 Notion 데이터를 활용하여 개인화된 건강 식단을 추천합니다.
반드시 다음 순서로 작업하세요:
1. **알레르기 정보 필수 확인** - 알레르기 식재료가 포함된 메뉴는 절대 추천 금지
2. **식단 기록 분석** - 최근 7일간 부족한 영양소 파악
3. **선호 음식 우선** - 사용자가 좋아하는 음식 종류 중심으로 추천
4. **다이어트 목표 반영** - 칼로리와 영양소를 목표에 맞게 조절
```

**Backstory 핵심 원칙**:
- **최우선 원칙: 알레르기 안전** - 알레르기 식재료 포함 메뉴는 어떤 경우에도 추천하지 않음
- **개인화 영양 관리** - Notion에서 가져온 실시간 식단 기록 분석

#### 3.2 스케줄러 에이전트 (`agents/scheduler_agent.py`)
**Goal 개선**:
```
Notion에서 가져온 사용자의 가용 시간을 최우선으로 고려하여
시간 내 완성 가능한 메뉴만 추천합니다.

시간 제약 기준:
- 15분 이하: 즉석 조리 음식, 배달 음식, 편의점 간편식만 추천
- 30분 이하: 간단 조리 또는 빠른 배달 가능 메뉴 추천
- 30분 이상: 다양한 조리법 메뉴 추천 가능
```

**Backstory 핵심 원칙**:
- **핵심 원칙: 시간 제약 엄수** - 조리 시간 + 배달 시간이 가용 시간을 초과하는 메뉴는 절대 추천하지 않음
- **특별 상황 대응** - 15분 이하 극도로 짧은 시간, 야간 시간대, 교대 근무 상황 고려

#### 3.3 예산 관리자 에이전트 (`agents/budget_agent.py`)
**Goal 개선**:
```
Notion에서 가져온 사용자의 예산 현황을 분석하여
남은 예산 범위 내에서 최고의 가성비 메뉴를 추천합니다.

우선순위:
1. **예산 준수**: 남은 예산을 절대 초과하지 않는 메뉴만 추천
2. **선호 가격대**: 사용자의 선호 가격대를 최우선 고려
3. **가성비**: 가격 대비 영양가, 양, 만족도가 높은 메뉴 선정
```

#### 3.4 종합 판단 코디네이터 (`agents/coordinator_agent.py`)
**Backstory 핵심 강화**:
```
**절대 원칙: Notion 실시간 데이터 우선**
다른 에이전트들이 Notion에서 가져온 개인화 정보를 종합합니다:
- 영양사의 알레르기/선호도 분석 (가장 중요!)
- 스케줄러의 가용 시간 제약 (절대 준수)
- 총무의 예산 범위 (절대 초과 금지)
- 맛슐랭의 취향 반영
- 요리사의 실행 가능성

**의사결정 가중치**
- 영양사: 30% (알레르기 안전 + 건강)
- 총무: 25% (예산 준수 + 가성비)
- 맛슐랭: 20% (맛과 만족도)
- 스케줄러: 15% (시간 제약 준수)
- 요리사: 10% (집밥 실용성)
```

---

### 4. Task 설명 개선 (Notion 데이터 우선 사용 명시)

`crew.py`의 `create_full_recommendation_tasks` 함수에서 각 task description을 Notion 데이터 기반으로 재작성했습니다.

#### 4.1 영양사 Task
```python
🔴 **최우선: 알레르기 확인**
1. '사용자 선호도 조회' 도구를 **반드시 먼저** 사용하여 알레르기 정보를 확인하세요.
2. 알레르기 식재료가 포함된 메뉴는 절대 추천하지 마세요!

📊 **Notion 데이터 분석**
3. '식단 기록 조회' 도구로 최근 7일간 식단을 분석하세요.
4. 부족한 영양소를 파악하고 보완 방향을 제시하세요.

🎯 **개인화된 추천**
5. 사용자의 선호 음식 종류를 우선적으로 고려하세요.
6. 다이어트 목표에 맞는 칼로리 범위의 메뉴를 선정하세요.
```

#### 4.2 예산 관리자 Task
```python
💰 **Notion 예산 데이터 확인**
1. '예산 현황 조회' 도구를 **반드시 먼저** 사용하여 Notion에서 예산 정보를 가져오세요.
2. 남은 예산과 선호 가격대를 확인하세요.

🔒 **예산 범위 엄수**
3. 남은 예산을 절대 초과하지 않는 메뉴만 선정하세요.
4. 선호 가격대 범위 내의 메뉴를 우선적으로 고려하세요.
```

#### 4.3 스케줄러 Task
```python
⏰ **Notion 일정 데이터 확인**
1. '사용자 일정 조회' 도구를 **반드시 먼저** 사용하여 Notion에서 가용 시간을 가져오세요.
2. 식사 시간대와 가용 시간(분)을 정확히 파악하세요.

🔒 **시간 제약 엄수**
3. 가용 시간을 절대 초과하지 않는 메뉴만 선정하세요.
4. 15분 이하: 즉석 조리/배달/간편식만 추천
5. 30분 이하: 간단 조리 또는 빠른 배달 메뉴 추천
```

#### 4.4 코디네이터 Task
```python
🎯 **Notion 실시간 데이터 기반 종합 판단**
다음 전문가들이 Notion에서 가져온 개인화 데이터를 분석했습니다:
- 영양사: Notion 알레르기/선호도/식단 기록 분석
- 총무: Notion 예산 현황 분석
- 스케줄러: Notion 일정 및 가용 시간 분석

🔴 **절대 원칙**
1. 알레르기 식재료가 포함된 메뉴는 절대 추천 금지
2. 가용 시간을 초과하는 메뉴는 절대 추천 금지
3. 남은 예산을 초과하는 메뉴는 절대 추천 금지
```

**파일**: `crew.py`

---

## 📊 최적화 효과

### Before (Mock 데이터 중심)
- Tools가 JSON 형태로만 데이터 반환
- 에이전트들이 알레르기, 시간 제약, 예산 제약을 느슨하게 적용
- 개인화 정보가 충분히 반영되지 않음

### After (Notion MCP 중심)
- Tools가 구조화되고 강조된 형태로 데이터 반환
- "절대 추천 금지", "반드시 먼저 사용" 등 명확한 지시
- 알레르기, 시간, 예산을 절대적 제약 조건으로 설정
- 개인화 정보를 모든 의사결정의 중심으로 배치

---

## 🔍 테스트 방법

### 1. MCP 서버 에러 확인
```bash
# Streamlit 앱 실행 시 JSON-RPC 에러가 사라졌는지 확인
streamlit run app.py
```

**기대 결과**: `ERROR:mcp.client.stdio:Failed to parse JSONRPC message` 에러가 더 이상 발생하지 않음

### 2. 알레르기 반영 테스트 (소윤 페르소나)
```
사용자 선택: 소윤 (갑각류 알레르기)
질문: "오늘 저녁 메뉴 추천해줘"
```

**기대 결과**: 
- 영양사가 알레르기를 최우선 확인
- 갑각류(새우, 게 등)가 포함된 메뉴는 절대 추천하지 않음
- 추천 이유에 "갑각류 알레르기 고려"가 명시됨

### 3. 시간 제약 테스트 (소윤 페르소나)
```
사용자 선택: 소윤 (15분 식사 시간)
질문: "오늘 저녁 메뉴 추천해줘"
```

**기대 결과**:
- 스케줄러가 15분 이하 제약 강조
- 즉석 조리, 배달, 간편식만 추천
- 30분 이상 소요되는 메뉴는 절대 추천하지 않음

### 4. 예산 제약 테스트
```
사용자 선택: 현우 (남은 예산 8,000원)
질문: "오늘 저녁 메뉴 추천해줘"
```

**기대 결과**:
- 총무가 남은 예산 8,000원 엄수
- 8,000원 이하 메뉴만 추천
- 선호 가격대 범위 내 메뉴 우선

### 5. 개인화 종합 테스트
```
사용자별로 동일한 질문을 했을 때 완전히 다른 추천이 나오는지 확인
```

**기대 결과**:
- 소윤: 15분 내, 분식 중심, 갑각류 제외
- 태식: 한식 선호, 따뜻한 음식, 전자레인지 조리
- 지민: 채식 중심, 버섯 제외, 식이섬유 풍부
- 현우: 헬스 후 가벼운 식사, 고단백 저칼로리, 유당 제외
- 라미: 벌크업용 고단백 고칼로리, 운동 전후 타이밍

---

## 🚀 다음 단계

1. **레시피 도구 개선**: 현재 레시피 도구는 외부 API 대신 AI 생성을 사용하고 있어, 실제 레시피 DB 연동 고려
2. **메뉴 검색 도구 개선**: 더 다양한 필터링 옵션 추가 (조리 방법, 요리 난이도 등)
3. **대화 맥락 개선**: 여러 턴의 대화에서 이전 맥락을 더 정확하게 유지
4. **A/B 테스트**: 최적화 전후 추천 품질 비교

---

## 📝 주요 변경 파일 요약

1. `mcp_servers/notion_server_real.py` - print문 제거 (JSON-RPC 에러 해결)
2. `tools/notion_tools.py` - Tools 출력 포맷 개선 (개인화 정보 강조)
3. `agents/nutrition_agent.py` - 영양사 에이전트 프롬프트 강화
4. `agents/scheduler_agent.py` - 스케줄러 에이전트 프롬프트 강화
5. `agents/budget_agent.py` - 예산 관리자 에이전트 프롬프트 강화
6. `agents/coordinator_agent.py` - 코디네이터 에이전트 프롬프트 강화
7. `crew.py` - Task 설명 개선 (Notion 데이터 기반 명시)

---

## 🎉 결론

이제 전체 워크플로우가 **Notion MCP를 통해 가져온 실시간 개인화 데이터를 중심**으로 작동합니다. 모든 에이전트가 개인화 정보를 최우선으로 고려하며, 알레르기·시간·예산 제약을 절대적 조건으로 준수합니다.

